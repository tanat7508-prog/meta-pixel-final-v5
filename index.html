<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meta Pixel + Make.com (Conditional & Contact Tracking)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap');
    :root { --pink:#ff517a; --ink:#111; --bg:#fff6f8; }
    *{box-sizing:border-box}
    body {font-family:'Prompt',system-ui,sans-serif;background:var(--bg);text-align:center;margin:0;padding:24px;}
    h2 {color:var(--pink);margin-top:0;}
    .btn {background:#111;color:#fff;border:none;border-radius:8px;padding:10px 16px;margin:6px;cursor:pointer;font-weight:600;font-size:14px;min-width:160px;}
    .btn:hover {opacity:.9;}
    .wrap-btns {display:flex;flex-wrap:wrap;justify-content:center;gap:8px;max-width:980px;margin:0 auto 24px;}
    .log {background:#0f1116;color:#0f0;font-family:monospace;font-size:12px;padding:12px;border-radius:8px;text-align:left;max-width:980px;margin:0 auto;min-height:140px;box-shadow:0 8px 20px rgba(0,0,0,.2);white-space:pre-wrap}
    .popup {position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
    .popup-content {background:#fff;padding:24px;border-radius:12px;width:360px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.2);}
    .popup input {width:100%;padding:10px;font-size:16px;margin-top:10px;border:1px solid #ccc;border-radius:8px;}
    .popup button {margin-top:12px;padding:10px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer;}
    .btn-confirm {background:var(--pink);color:#fff;}
    .btn-cancel {background:#999;color:#fff;margin-left:8px;}
    .promo-box {border:1px solid #eee;padding:10px;margin-top:10px;border-radius:8px;background:#fff3f7;cursor:pointer;}
    .promo-box:hover {background:#ffe5ef;}
    .panel {max-width:980px;margin:0 auto 18px;background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    .panel input[type="number"]{width:160px;padding:10px;border:1px solid #ddd;border-radius:8px}
    .badge {display:inline-block;background:#eef;padding:6px 10px;border-radius:999px;font-size:12px;color:#334;}
  </style>

  <!-- ‚úÖ Meta Pixel -->
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
    (window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1151872007088616'); /* ‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Pixel ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
    fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1151872007088616&ev=PageView&noscript=1"/></noscript>
</head>

<body>
  <h2>üéØ ‡πÅ‡∏ú‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Event (Pixel + Make.com) ‚Äî ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç + ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° Contact Link</h2>

  <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
  <div class="panel">
    <span class="badge">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <strong id="badgeUser">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</strong></span>
    <input type="number" id="purchaseValue" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô 100)" />
    <button class="btn" id="btnConditional">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡∏∑‡πâ‡∏≠)</button>
  </div>

  <div class="wrap-btns">
    <button class="btn" onclick="fire('PageView')">PageView</button>
    <button class="btn" onclick="openPromotion()">ViewContent (Promotion)</button>
    <button class="btn" onclick="fire('AddToCart','Sony WF-1000XM5',8990)">AddToCart</button>
    <button class="btn" onclick="fire('Purchase','Sony WF-1000XM5',8990)">Purchase</button>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° Contact ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå + ‡∏™‡πà‡∏á destination -->
    <button class="btn" onclick="contactLine()">Contact_LINE</button>
    <button class="btn" onclick="contactTelegram()">Contact_Telegram</button>

    <button class="btn" onclick="openLogin()">Login_Success</button>
    <button class="btn" onclick="openTopup()">Submit_Topup</button>
  </div>

  <div id="logBox" class="log">[LOG] ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö Event</div>

  <!-- ‚úÖ Popup: Promotion -->
  <div class="popup" id="popupPromo">
    <div class="popup-content">
      <h3>üéâ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</h3>
      <div class="promo-box" onclick="selectPromo('‡πÇ‡∏õ‡∏£‡∏•‡∏î 50% ‡∏´‡∏π‡∏ü‡∏±‡∏á Sony')">üéß ‡πÇ‡∏õ‡∏£‡∏•‡∏î 50% ‡∏´‡∏π‡∏ü‡∏±‡∏á Sony</div>
      <div class="promo-box" onclick="selectPromo('‡πÇ‡∏õ‡∏£ 1 ‡πÅ‡∏ñ‡∏° 1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°')">‚ö° ‡πÇ‡∏õ‡∏£ 1 ‡πÅ‡∏ñ‡∏° 1 ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°</div>
      <div class="promo-box" onclick="selectPromo('‡πÇ‡∏õ‡∏£‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®')">üöö ‡πÇ‡∏õ‡∏£‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</div>
      <button class="btn-cancel" onclick="closePromotion()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- ‚úÖ Popup: Login -->
  <div class="popup" id="popupLogin">
    <div class="popup-content">
      <h3>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <div>
        <button class="btn-confirm" onclick="submitLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button class="btn-cancel" onclick="closeLogin()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Popup: Topup -->
  <div class="popup" id="popupTopup">
    <div class="popup-content">
      <h3>üí∞ ‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°</h3>
      <input type="number" id="topupAmount" placeholder="‡πÄ‡∏ä‡πà‡∏ô 500" />
      <div>
        <button class="btn-confirm" onclick="submitTopup()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button class="btn-cancel" onclick="closeTopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <script>
    /* ------------------ CONFIG ------------------ */
    const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/js1dr6n6g8917p5q8ulbjpd9aoh8koci"; // ‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Webhook ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const PLATFORM = "Meta Pixel + Make";
    const CHANNEL  = "Website";
    const CURRENCY = "THB";

    /* ------------------ STATE ------------------- */
    let USERNAME = "-";
    const logBox = document.getElementById("logBox");
    const badgeUser = document.getElementById("badgeUser");
    const purchaseInput = document.getElementById("purchaseValue");
    const btnConditional = document.getElementById("btnConditional");

    /* --------------- HELPERS -------------------- */
    function log(msg){
      const t = new Date().toLocaleTimeString();
      logBox.textContent += `\n[${t}] ${msg}`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function sendToMake(payload){
      try {
        const res = await fetch(MAKE_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          keepalive: true
        });
        return res.ok;
      } catch(e){
        console.error("Make error:", e);
        return false;
      }
    }

    // ‚úÖ ‡∏¢‡∏¥‡∏á Event (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö extra fields ‡πÄ‡∏ä‡πà‡∏ô destination)
    async function fire(eventName, productName = "-", value = 0, extra = {}){
      const standardEvents = [
        'Purchase','Lead','AddToCart','InitiateCheckout',
        'CompleteRegistration','ViewContent','Contact'
      ];

      const baseParams = {
        value,
        currency: CURRENCY,
        content_name: productName,
        username: USERNAME,
        ...extra
      };

      if (standardEvents.includes(eventName)) {
        fbq('track', eventName, baseParams);
      } else {
        fbq('trackCustom', eventName, {
          event: eventName,
          product_name: productName,
          ...baseParams
        });
      }

      const payload = {
        event_name: eventName,
        product_name: productName,
        value,
        currency: CURRENCY,
        username: USERNAME,
        source: CHANNEL,
        platform: PLATFORM,
        event_time: Math.floor(Date.now()/1000),
        url: window.location.href,
        ...extra
      };

      const ok = await sendToMake(payload);
      if(ok){
        log(`‚úÖ Event: ${eventName} | Product: ${productName} | Value: ${value} | Extra: ${JSON.stringify(extra)} (${USERNAME})`);
      } else {
        log(`‚ö†Ô∏è ‡∏™‡πà‡∏á‡πÑ‡∏õ Make ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ${eventName}`);
      }
    }

    /* ------------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡∏¢‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ------------- */
    btnConditional.addEventListener('click', async () => {
      const amount = parseFloat(purchaseInput.value || 0);

      if (USERNAME === "-" || USERNAME === "") {
        await fire('Lead', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', 0);
        alert('‡∏™‡πà‡∏á Lead ‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏à‡∏∂‡∏á‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)');
        return;
      }

      if (amount > 0) {
        await fire('Purchase', '‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', amount);
        alert(`‡∏™‡πà‡∏á Purchase ‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ${amount} ${CURRENCY})`);
      } else {
        alert('‡∏Ñ‡∏∏‡∏ì‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
      }
    });

    /* ----------------- CONTACT LINKS ----------------- */
    async function contactLine(){
      const link = "https://lin.ee/bdJikPK";
      await fire('Contact_LINE', 'Contact LINE', 0, { destination: link });
      log(`üí¨ ${USERNAME} ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå LINE ‚Üí ${link}`);
      window.open(link, "_blank");
    }

    async function contactTelegram(){
      const link = "https://t.me/+zdnFoWzYm_dlMWE1";
      await fire('Contact_Telegram', 'Contact Telegram', 0, { destination: link });
      log(`üí¨ ${USERNAME} ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå Telegram ‚Üí ${link}`);
      window.open(link, "_blank");
    }

    /* ----------------- PROMOTION ----------------- */
    function openPromotion(){ document.getElementById("popupPromo").style.display = "flex"; }
    function closePromotion(){ document.getElementById("popupPromo").style.display = "none"; }
    async function selectPromo(promo){
      closePromotion();
      log(`üéØ ${USERNAME} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô: ${promo}`);
      await fire('ViewContent', promo, 0);
    }

    /* ------------------- LOGIN ------------------- */
    function openLogin(){ document.getElementById("popupLogin").style.display = "flex"; }
    function closeLogin(){ document.getElementById("popupLogin").style.display = "none"; }

    async function submitLogin(){
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      if(!u || !p){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password"); return; }
      USERNAME = u;
      badgeUser.textContent = `‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${USERNAME}`;
      closeLogin();
      log(`üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${USERNAME}`);
      await fire('Login_Success', 'User Login', 0);
    }

    /* ------------------- TOPUP ------------------- */
    function openTopup(){ document.getElementById("popupTopup").style.display = "flex"; }
    function closeTopup(){ document.getElementById("popupTopup").style.display = "none"; }

    async function submitTopup(){
      const amount = parseFloat(document.getElementById("topupAmount").value || 0);
      if(amount <= 0){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
      closeTopup();
      log(`üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏: ${amount} ‡∏ö‡∏≤‡∏ó`);
      await fire('Submit_Topup', 'Topup Custom Amount', amount);
    }

    /* -------------- export ‡πÑ‡∏õ window ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ debug -------------- */
    window.openPromotion = openPromotion;
    window.closePromotion = closePromotion;
    window.selectPromo = selectPromo;
    window.openLogin = openLogin;
    window.closeLogin = closeLogin;
    window.submitLogin = submitLogin;
    window.openTopup = openTopup;
    window.closeTopup = closeTopup;
    window.submitTopup = submitTopup;
    window.fire = fire;
    window.contactLine = contactLine;
    window.contactTelegram = contactTelegram;
  </script>
</body>
</html>
